<?xml version="1.0" encoding="UTF-8"?>
<?define ServerSource=..\..\..\server\dist ?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="PlayPalace" Manufacturer="XGDevGroup" Version="11.0.0.0" UpgradeCode="{b40ba410-e0df-422a-9f26-f630a7fe3d1d}" Language="1033" Codepage="1252">
    <Icon Id="ProductIcon" SourceFile="assets/product.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="SERVERHOST" Value="0.0.0.0" />
    <Property Id="SERVERPORT" Value="8000" />
    <Property Id="SERVERALLOWINSECURE" Value="0" />
    <Property Id="SERVERENABLESSL" Value="0" />
    <Property Id="SERVERCERTPATH" Secure="yes" />
    <Property Id="SERVERKEYPATH" Secure="yes" />
    <MajorUpgrade Schedule="afterInstallInitialize" DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="PlayPalace">
        <Directory Id="CLIENTDIR" Name="Client" />
        <Directory Id="SERVERDIR" Name="Server" />
        <Directory Id="TOOLSDIR" Name="tools" />
      </Directory>
    </StandardDirectory>
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="PlayPalaceProgramMenu" Name="PlayPalace" />
    </StandardDirectory>
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="CONFIGDIR" Name="PlayPalace" />
    </StandardDirectory>

    <Component Id="ClientShortcutComponent" Directory="PlayPalaceProgramMenu" Guid="{a7c3e1d2-5f48-4b9a-8e61-3d2c7f9b0a14}">
      <Shortcut Id="ClientStartMenuShortcut" Name="PlayPalace Client" Target="[CLIENTDIR]PlayPalace.exe" WorkingDirectory="CLIENTDIR" Icon="ProductIcon" IconIndex="0" />
      <RemoveFolder Id="RemovePlayPalaceProgramMenu" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\PlayPalace" Name="ClientShortcut" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <Component Id="ServerExecutable" Directory="SERVERDIR" Guid="{9c0b7f68-4c76-4e3a-aa83-07c2c0cc8171}">
      <File Id="PlayPalaceServerExe" Source="$(var.ServerSource)\PlayPalaceServer.exe" KeyPath="yes" />
      <ServiceInstall
          Id="PlayPalaceServiceInstall"
          Name="PlayPalaceServer"
          DisplayName="PlayPalace Server"
          Type="ownProcess"
          Start="auto"
          ErrorControl="normal"
          Description="Runs the PlayPalace multiplayer server backend."
          Account="LocalSystem"
          Arguments="--host [SERVERHOST] --port [SERVERPORT]">
        <ServiceDependency Id="W32Time" />
      </ServiceInstall>
      <ServiceControl Id="PlayPalaceServiceControl" Name="PlayPalaceServer" Stop="both" Remove="uninstall" Wait="yes" />
    </Component>

    <Component Id="ProgramDataFolderComponent" Directory="CONFIGDIR" Guid="{9f8b8d5d-64d7-4f67-a921-bcd5634b9619}">
      <CreateFolder />
    </Component>

    <Component Id="ConfigureScriptComponent" Directory="TOOLSDIR" Guid="{3cc85d8a-3ab2-4e13-93b6-5530f99c12f7}">
      <File Id="ConfigureServerScript" Source="..\configure_server.ps1" KeyPath="yes" />
    </Component>

    <Component Id="SelfSignedScriptComponent" Directory="TOOLSDIR" Guid="{5586b47e-564f-47fb-9620-418a564a9104}">
      <File Id="GenerateCertScript" Source="..\generate_self_signed.ps1" KeyPath="yes" />
    </Component>

    <ComponentGroup Id="ClientComponents">
      <ComponentRef Id="ClientShortcutComponent" />
    </ComponentGroup>

    <ComponentGroup Id="ServerComponents">
      <ComponentRef Id="ServerExecutable" />
      <ComponentRef Id="ProgramDataFolderComponent" />
    </ComponentGroup>

    <ComponentGroup Id="InstallerToolsComponents">
      <ComponentRef Id="ConfigureScriptComponent" />
      <ComponentRef Id="SelfSignedScriptComponent" />
    </ComponentGroup>

    <Feature Id="ClientFeature" Title="!(loc.FeatureClient)" Level="1" AllowAbsent="yes" ConfigurableDirectory="CLIENTDIR">
      <ComponentGroupRef Id="ClientComponents" />
      <ComponentGroupRef Id="ClientHarvestedFiles" />
    </Feature>

    <Feature Id="ServerFeature" Title="!(loc.FeatureServer)" Level="1" AllowAbsent="yes" ConfigurableDirectory="SERVERDIR">
      <ComponentGroupRef Id="ServerComponents" />
      <ComponentGroupRef Id="InstallerToolsComponents" />
    </Feature>

    <!-- Deferred quiet exec: configure server after install -->
    <CustomAction Id="ConfigureServerAction"
                  BinaryRef="Wix4UtilCA_X64"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <CustomAction Id="SetConfigureServerActionData"
                  Property="ConfigureServerAction"
                  Value='powershell.exe -ExecutionPolicy Bypass -NoProfile -File "[#ConfigureServerScript]" -ProgramDataPath "[CommonAppDataFolder]PlayPalace" -HostName "[SERVERHOST]" -Port "[SERVERPORT]" -AllowInsecure [SERVERALLOWINSECURE] -EnableSsl [SERVERENABLESSL] -CertificatePath "[SERVERCERTPATH]" -PrivateKeyPath "[SERVERKEYPATH]"' />

    <InstallExecuteSequence>
      <Custom Action="SetConfigureServerActionData" Before="ConfigureServerAction" Condition="(&amp;ServerFeature=3) AND (!ServerFeature=2)" />
      <Custom Action="ConfigureServerAction" After="InstallFiles" Condition="(&amp;ServerFeature=3) AND (!ServerFeature=2)" />
    </InstallExecuteSequence>

    <!-- Immediate quiet exec: validate certificate paths -->
    <CustomAction Id="SetValidateCertCmd"
                  Property="WixQuietExecCmdLine"
                  Value='powershell.exe -ExecutionPolicy Bypass -NoProfile -Command "&amp; { if (-not \"[SERVERCERTPATH]\") { throw \"Certificate path missing\" } if (-not (Test-Path \"[SERVERCERTPATH]\")) { throw \"Certificate path not found\" } if (-not \"[SERVERKEYPATH]\") { throw \"Key path missing\" } if (-not (Test-Path \"[SERVERKEYPATH]\")) { throw \"Key path not found\" } Write-Output \"Certificate inputs look valid.\" }"' />

    <CustomAction Id="ValidateCertAction"
                  BinaryRef="Wix4UtilCA_X64"
                  DllEntry="WixQuietExec64"
                  Execute="immediate"
                  Return="check"
                  Impersonate="yes" />

    <!-- Immediate quiet exec: generate self-signed certificate -->
    <CustomAction Id="SetGenerateCertCmd"
                  Property="WixQuietExecCmdLine"
                  Value='powershell.exe -ExecutionPolicy Bypass -NoProfile -File "[#GenerateCertScript]" -OutDir "[CommonAppDataFolder]PlayPalace\ssl"' />

    <CustomAction Id="GenerateCertAction"
                  BinaryRef="Wix4UtilCA_X64"
                  DllEntry="WixQuietExec64"
                  Execute="immediate"
                  Return="check"
                  Impersonate="no" />

    <UI>
      <TextStyle Id="Tahoma" FaceName="Tahoma" Size="8" />
      <ui:WixUI Id="WixUI_InstallDir" />

      <Dialog Id="ServerConfigDlg" Width="370" Height="295" Title="!(loc.ConfigDialogTitle)">
        <Control Id="Title" Type="Text" X="15" Y="6" Width="340" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.ConfigDialogTitle)" />
        <Control Id="Description" Type="Text" X="15" Y="23" Width="340" Height="30" Text="!(loc.ConfigDialogDescription)" />

        <Control Id="HostLabel" Type="Text" X="15" Y="60" Width="140" Height="10" Text="!(loc.ConfigHostLabel)" />
        <Control Id="HostEdit" Type="Edit" X="15" Y="72" Width="160" Height="18" Property="SERVERHOST" />

        <Control Id="PortLabel" Type="Text" X="190" Y="60" Width="60" Height="10" Text="!(loc.ConfigPortLabel)" />
        <Control Id="PortEdit" Type="Edit" X="190" Y="72" Width="70" Height="18" Property="SERVERPORT" />

        <Control Id="AllowInsecureCheck" Type="CheckBox" X="15" Y="100" Width="330" Height="16" Property="SERVERALLOWINSECURE" CheckBoxValue="1" Text="!(loc.ConfigAllowInsecure)" />

        <Control Id="EnableSslCheck" Type="CheckBox" X="15" Y="122" Width="330" Height="16" Property="SERVERENABLESSL" CheckBoxValue="1" Text="!(loc.ConfigEnableSsl)" />

        <Control Id="CertLabel" Type="Text" X="15" Y="145" Width="330" Height="10" Text="!(loc.ConfigCertPath)" />
        <Control Id="CertPath" Type="PathEdit" X="15" Y="157" Width="330" Height="18" Property="SERVERCERTPATH" />

        <Control Id="KeyLabel" Type="Text" X="15" Y="180" Width="330" Height="10" Text="!(loc.ConfigKeyPath)" />
        <Control Id="KeyPath" Type="PathEdit" X="15" Y="192" Width="330" Height="18" Property="SERVERKEYPATH" />

        <Control Id="GenerateCertBtn" Type="PushButton" X="15" Y="217" Width="160" Height="17" Text="!(loc.ConfigGenerateCert)">
          <Publish Event="SetProperty" Value="SERVERCERTPATH=[CommonAppDataFolder]PlayPalace\ssl\playpalace_cert.cer" Condition='SERVERENABLESSL = "1"' />
          <Publish Event="SetProperty" Value="SERVERKEYPATH=[CommonAppDataFolder]PlayPalace\ssl\playpalace_key.pfx" Condition='SERVERENABLESSL = "1"' />
          <Publish Event="DoAction" Value="SetGenerateCertCmd" Condition='SERVERENABLESSL = "1"' />
          <Publish Event="DoAction" Value="GenerateCertAction" Condition='SERVERENABLESSL = "1"' />
        </Control>

        <Control Id="ValidateCertBtn" Type="PushButton" X="185" Y="217" Width="160" Height="17" Text="!(loc.ConfigValidateCert)">
          <Publish Event="DoAction" Value="SetValidateCertCmd" Condition='SERVERENABLESSL = "1"' />
          <Publish Event="DoAction" Value="ValidateCertAction" Condition='SERVERENABLESSL = "1"' />
        </Control>

        <Control Id="Back" Type="PushButton" X="150" Y="268" Width="56" Height="17" Text="!(loc.WixUIBack)">
          <Publish Event="NewDialog" Value="InstallDirDlg" Condition="1" />
        </Control>
        <Control Id="Next" Type="PushButton" X="222" Y="268" Width="56" Height="17" Default="yes" Text="!(loc.WixUINext)">
          <Publish Event="NewDialog" Value="VerifyReadyDlg" Condition="1" />
        </Control>
        <Control Id="Cancel" Type="PushButton" X="294" Y="268" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
          <Publish Event="SpawnDialog" Value="CancelDlg" Condition="1" />
        </Control>
      </Dialog>

      <!-- Override InstallDirDlg Next to route through ServerConfigDlg when server feature is selected -->
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ServerConfigDlg" Condition="(&amp;ServerFeature=3) AND (NOT Installed)" Order="2" />
      <!-- Override VerifyReadyDlg Back to go to ServerConfigDlg when server feature is selected -->
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="ServerConfigDlg" Condition="(&amp;ServerFeature=3) AND (NOT Installed)" Order="2" />
    </UI>

    <WixVariable Id="WixUILicenseRtf" Value="LICENSE_PLACEHOLDER.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="assets/banner.png" />
    <WixVariable Id="WixUIDialogBmp" Value="assets/dialog.png" />
  </Package>
</Wix>
