#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVER_DIR="$ROOT/server"

need_cmd() {
  local cmd="$1"
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Error: '$cmd' is required but not found in PATH." >&2
    exit 1
  fi
}

check_python() {
  if ! command -v python3 >/dev/null 2>&1; then
    echo "Error: python3 is required (>= 3.11)." >&2
    exit 1
  fi
  python3 - <<'PY'
import sys
if sys.version_info < (3, 11):
    raise SystemExit("Error: Python 3.11+ is required.")
PY
}

check_server_deps() {
  if ! (cd "$SERVER_DIR" && uv run python - <<'PY'
import websockets
import mashumaro
import fluent_compiler
import babel
import openskill
import argon2
PY
  ); then
    echo "Error: server dependencies are missing." >&2
    echo "Run: cd server && uv sync" >&2
    exit 1
  fi
}

need_cmd uv
check_python
check_server_deps

(cd "$SERVER_DIR" && uv run python main.py)
